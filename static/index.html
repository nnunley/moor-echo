<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Web REPL</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', monospace;
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        
        #chat-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        #messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #3e3e3e;
            padding: 10px;
            margin-bottom: 10px;
            background: #2d2d2d;
        }
        
        .message {
            margin: 5px 0;
            padding: 5px;
        }
        
        .system-message {
            color: #4ec9b0;
            font-style: italic;
        }
        
        .chat-message {
            color: #9cdcfe;
        }
        
        .error-message {
            color: #f44747;
        }
        
        .result-message {
            color: #dcdcaa;
        }
        
        #repl-input {
            width: 100%;
            padding: 10px;
            background: #2d2d2d;
            border: 1px solid #3e3e3e;
            color: #d4d4d4;
            font-family: inherit;
            font-size: 14px;
        }
        
        #player-info {
            margin-bottom: 10px;
            padding: 10px;
            background: #2d2d2d;
            border: 1px solid #3e3e3e;
        }
        
        .repl-output {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <h1>Echo Web REPL - Multiplayer Demo</h1>
        
        <div id="player-info">
            <span>Current Player: <span id="current-player">Not connected</span></span>
        </div>
        
        <div id="messages"></div>
        
        <input type="text" id="repl-input" placeholder="Enter Echo command..." autofocus>
    </div>
    
    <script>
        let ws = null;
        let currentPlayer = 'Not connected';
        
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8081/ws');
            
            ws.onopen = () => {
                addMessage('Connected to Echo server', 'system-message');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                }
            };
            
            ws.onerror = (error) => {
                addMessage('WebSocket error: ' + error, 'error-message');
            };
            
            ws.onclose = () => {
                addMessage('Disconnected from server', 'system-message');
                setTimeout(connectWebSocket, 3000);
            };
        }
        
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'ChatMessage':
                    if (data.data.player.startsWith('system@')) {
                        addMessage('ðŸ“¨ ' + data.data.message, 'chat-message');
                    } else {
                        addMessage(data.data.player + ': ' + data.data.message, 'chat-message');
                    }
                    break;
                    
                case 'Output':
                    addMessage(data.data.content, 'repl-output');
                    break;
                    
                case 'Error':
                    addMessage('Error: ' + data.data.content, 'error-message');
                    break;
                    
                case 'Result':
                    addMessage('=> ' + data.data.output + ' (' + data.data.duration_ms + 'ms)', 'result-message');
                    break;
                    
                case 'StateUpdate':
                    if (data.data.snapshot.current_player) {
                        currentPlayer = data.data.snapshot.current_player;
                        document.getElementById('current-player').textContent = currentPlayer;
                    }
                    break;
            }
        }
        
        function addMessage(text, className) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message ' + className;
            div.textContent = text;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function sendCommand(command) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const request = {
                    code: command,
                    is_program: false
                };
                ws.send(JSON.stringify(request));
                addMessage('> ' + command, 'repl-output');
            }
        }
        
        document.getElementById('repl-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const input = e.target;
                const command = input.value.trim();
                if (command) {
                    sendCommand(command);
                    input.value = '';
                }
            }
        });
        
        // Connect when page loads
        connectWebSocket();
    </script>
</body>
</html>